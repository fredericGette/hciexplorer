<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        .event {
            border: 1px solid;
            border-radius: 0.25rlh;
        }
    </style>
</head>
<body>
<div>
    <form method="POST" enctype="multipart/form-data" action="http://localhost:8080/upload">
        <table>
            <tr><td>File to upload:</td><td><input type="file" name="file" /></td></tr>
            <tr><td></td><td><input type="submit" value="Upload" /></td></tr>
        </table>
    </form>
</div>
<div>
    <button onclick="downloadMessages()">Messages</button>
</div>
<div id="messages">
</div>
<script type="text/javascript">
    function lastMessage(messages, column)
    {
        let foundMessage = undefined;
        messages.forEach(message => {
            if (message.column == column)
            {
                foundMessage = message;
            }
        });
        return foundMessage;
    }

    async function downloadMessages() {
        debugger;
        const response = await fetch('http://localhost:8080/messages');
        const messages = await response.json();
        console.log(messages);

        let row1 = -1;
        let row2 = -1;
        let previousMessage = undefined;
        let defaultHeight = 2;
        messages.forEach(message => {
            message.beginTimestamp = new Date(message.beginTimestamp);
            message.endTimestamp = new Date(message.endTimestamp);
            message.number = previousMessage ? previousMessage.number+1 : 1;

            if (lastMessage(messages,1) == undefined || lastMessage(messages,1).endTimestamp.getTime()<=message.beginTimestamp.getTime())
            {
                if (previousMessage && previousMessage.column==2)
                {
                    if (lastMessage(messages,1).endTimestamp.getTime()>lastMessage(messages,2).endTimestamp.getTime())
                    {
                        lastMessage(messages,1).height=row2+defaultHeight+defaultHeight/2-row1;
                        row1 = row2+defaultHeight+defaultHeight/2;
                    }
                    else if (lastMessage(messages,1).endTimestamp.getTime()==lastMessage(messages,2).endTimestamp.getTime())
                    {
                        row1 = row2+defaultHeight;
                    }
                    else
                    {
                        lastMessage(messages,1).height=row2+defaultHeight/2-row1;
                        row1 = row2+defaultHeight/2;
                    }
                }
                else
                {
                    row1+=defaultHeight;
                }
                message.column=1;
                message.rowStart=row1;
                message.height=defaultHeight;
            }
            else
            {
                if (previousMessage && previousMessage.column==1)
                {
                    row2 = row1+defaultHeight/2;
                }
                else
                {
                    row2+=defaultHeight;
                }

                lastMessage(messages,1).height=row2+defaultHeight;

                message.column=2;
                message.rowStart=row2;
                message.height=defaultHeight;
            }
            previousMessage = message;
        });

        let maxRow = 0;
        messages.forEach(message => {
            if (message.rowStart+message.height > maxRow)
            {
                maxRow = message.rowStart+message.height;
            }
        });

        const divGrid = document.getElementById("messages");
        divGrid.setAttribute("style","display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat("+maxRow+", 1rlh);");

        messages.forEach(message => {
            const divMessage = document.createElement("div");
            divMessage.classList.add('event');
            divMessage.innerHTML += ""+message.number+" "+message.beginTimestamp.getTime()+" ";
            if (message.type == "Event")
            {
                divMessage.classList.add('event');
                divMessage.innerHTML += "EVENT";
            }
            else if (message.type == "Command")
            {
                divMessage.classList.add('event');
                divMessage.innerHTML += "COMMAND"+" "+message.opCode;
            }
            else if (message.type == "AclData")
            {
                divMessage.classList.add('event');
                divMessage.innerHTML += "DATA";
            }
            divMessage.innerHTML += "<br/>";
            divMessage.innerHTML += message.endTimestamp.getTime();
            if (message.ioCtlStatus == undefined && message.code=="COMMAND_COMPLETE")
            {
                divMessage.innerHTML += " "+message.code+":"+message.commandOpCode
            }
            else if (message.ioCtlStatus)
            {
                divMessage.innerHTML += " "+message.ioCtlStatus
            }
            divMessage.setAttribute("style","grid-column-start: "+message.column+"; grid-row-start: "+message.rowStart+"; grid-row-end: "+(message.rowStart+message.height));
            document.getElementById("messages").appendChild(divMessage);
        });
    }
</script>
</body>
</html>