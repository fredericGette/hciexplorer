<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        .event {
            border: 1px solid;
            border-radius: 0.25rlh;
            font: 0.6rem "Fira Sans", sans-serif;
        }
    </style>
</head>
<body>
<div>
    <form method="POST" enctype="multipart/form-data" action="http://localhost:8080/upload">
        <table>
            <tr><td>File to upload:</td><td><input type="file" name="file" /></td></tr>
            <tr><td></td><td><input type="submit" value="Upload" /></td></tr>
        </table>
    </form>
</div>
<div>
    <button onclick="downloadMessages()">Messages</button>
</div>
<div id="messages">
</div>
<script type="text/javascript">
    function lastMessage(messages, column, i)
    {
        let foundMessage = undefined;
        for (let j=0; j<messages.length; j++)
        {
            if (j != i && messages[j].column == column)
            {
                foundMessage = messages[j];
            }
        }
        return foundMessage;
    }

    async function downloadMessages() {
        debugger;
        const response = await fetch('http://localhost:8080/messages');
        const messages = await response.json();
        console.log(messages);

        let column = [];
        let defaultHeight = 2;
        for (let i=0; i<messages.length; i++)
        {
            messages[i].beginTimestamp = new Date(messages[i].beginTimestamp).getTime();
            messages[i].endTimestamp = new Date(messages[i].endTimestamp).getTime();
            messages[i].number = i;

            // Assign column
            // 1: command
            // 2: event command complete
            // 3: other event
            // 4: data

            if (messages[i].type == "Command")
            {
                messages[i].column = 1;
            }
            else if (messages[i].type == "Event" && messages[i].code=="COMMAND_COMPLETE")
            {
                messages[i].column = 2;
            }
            else if (messages[i].type == "Event")
            {
                messages[i].column = 3;
            }
            else
            {
                messages[i].column = 4;
            }

            if (i == 0)
            {
                // First message
                messages[i].rowStart = 1;
                messages[i].height=defaultHeight;
            }
            else
            {
                messages[i].height=defaultHeight;

                if (messages[i].beginTimestamp < messages[i-1].endTimestamp && messages[i].column == messages[i-1].column)
                {
                    messages[i].column = 5;
                }

                let previousMessageBeginSameTime = undefined;
                for (let j=i-1; j>=0; j--)
                {
                    if (messages[i].beginTimestamp == messages[j].beginTimestamp)
                    {
                        previousMessageBeginSameTime = messages[j];
                    }
                }

                if (previousMessageBeginSameTime != undefined && (lastMessage(messages, messages[i].column, i) == undefined || lastMessage(messages, messages[i].column, i).rowStart < previousMessageBeginSameTime.rowStart))
                {
                    messages[i].rowStart = previousMessageBeginSameTime.rowStart;
                }
                else
                {
                    messages[i].rowStart = messages[i-1].rowStart + messages[i-1].height;
                }

            }

            column[messages[i].column] = messages[i];
        }

        let maxRow = 0;
        messages.forEach(message => {
            if (message.rowStart+message.height > maxRow)
            {
                maxRow = message.rowStart+message.height;
            }
        });

        const divGrid = document.getElementById("messages");
        divGrid.setAttribute("style","display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat("+maxRow+", 1rlh);");

        messages.forEach(message => {
            const divMessage = document.createElement("div");
            divMessage.classList.add('event');
            divMessage.innerHTML += ""+message.number+" "+message.beginTimestamp+" ";
            if (message.type == "Event")
            {
                divMessage.classList.add('event');
                divMessage.innerHTML += "EVENT";
            }
            else if (message.type == "Command")
            {
                divMessage.classList.add('event');
                divMessage.innerHTML += "COMMAND"+" "+message.opCode;
            }
            else if (message.type == "AclData")
            {
                divMessage.classList.add('event');
                divMessage.innerHTML += "DATA";
            }
            divMessage.innerHTML += "<br/>";
            divMessage.innerHTML += message.endTimestamp;
            if (message.ioCtlStatus == undefined && message.code=="COMMAND_COMPLETE")
            {
                divMessage.innerHTML += " "+message.code+":"+message.commandOpCode
            }
            else if (message.ioCtlStatus)
            {
                divMessage.innerHTML += " "+message.ioCtlStatus
            }
            divMessage.setAttribute("style","grid-column-start: "+message.column+"; grid-row-start: "+message.rowStart+"; grid-row-end: "+(message.rowStart+message.height));
            document.getElementById("messages").appendChild(divMessage);
        });
    }
</script>
</body>
</html>
